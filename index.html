<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SH Innovation í†µí•© ë§¤ì¶œ ì‹œìŠ¤í…œ (Ver 10.0 - í¼í™íŠ¸ ë§¤ì¹­)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f8f9fa; font-size: 0.85rem; }
        .header { background-color: #2c3e50; color: white; padding: 15px; margin-bottom: 15px; }
        .nav-tabs .nav-link.active { font-weight: bold; border-top: 3px solid #0d6efd; }
        .table-responsive { overflow-x: auto; white-space: nowrap; }
        .table th { background-color: #e9ecef; vertical-align: middle; text-align: center; white-space: nowrap; }
        .table td { vertical-align: middle; padding: 4px 8px; white-space: nowrap; }
        .negative { color: red; font-weight: bold; }
        .input-area { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; border: 1px solid #dee2e6; }
        .form-label { font-weight: bold; font-size: 0.8rem; margin-bottom: 2px; color: #495057; }
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 1; }
        .editing-mode { border: 2px solid #0d6efd; background-color: #f0f7ff; }
        .drop-zone {
            border: 2px dashed #0d6efd; border-radius: 10px; padding: 40px; text-align: center; background-color: #f8f9fa;
            transition: all 0.3s ease; cursor: pointer; margin-bottom: 15px;
        }
        .drop-zone:hover, .drop-zone.dragover { background-color: #e7f1ff; border-color: #0b5ed7; transform: scale(1.01); }
        .drop-zone p { margin: 0; color: #495057; font-weight: bold; font-size: 1.1rem; }
        .drop-icon { font-size: 2.5rem; color: #0d6efd; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div>
                <h4 class="m-0">ğŸ“Š SH Innovation í†µí•© ë§¤ì¶œ ì‹œìŠ¤í…œ</h4>
                <small class="text-light opacity-75">Ver 10.0: í¼í™íŠ¸ ìƒí’ˆëª… ë§¤ì¹­ + ë‹¤ì¤‘ ì—…ë¡œë“œ</small>
            </div>
            <div>
                <button class="btn btn-outline-light btn-sm" onclick="downloadData()">ğŸ’¾ ë°±ì—… ì €ì¥</button>
                <button class="btn btn-outline-light btn-sm" onclick="document.getElementById('backupInput').click()">ğŸ“‚ ë°±ì—… ë³µì›</button>
                <input type="file" id="backupInput" style="display:none" onchange="loadDataFromBackup(this)">
                <button class="btn btn-danger btn-sm ms-2" onclick="resetData()"> ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">ğŸ“ˆ ëŒ€ì‹œë³´ë“œ</button></li>
            <li class="nav-item"><button class="nav-link" id="db-tab" data-bs-toggle="tab" data-bs-target="#db" type="button">ğŸ“ ë§¤ì¶œ ë“±ë¡ (DB)</button></li>
            <li class="nav-item"><button class="nav-link" id="ads-tab" data-bs-toggle="tab" data-bs-target="#ads" type="button">ğŸ“¢ ê´‘ê³  ê´€ë¦¬</button></li>
            <li class="nav-item"><button class="nav-link" id="settlement-tab" data-bs-toggle="tab" data-bs-target="#settlement" type="button">ğŸ’° ì •ì‚° ê´€ë¦¬</button></li>
        </ul>

        <div class="tab-content p-3 bg-white border border-top-0 rounded-bottom shadow-sm">
            
            <div class="tab-pane fade show active" id="dashboard">
                <div class="d-flex justify-content-between mb-2">
                    <h5>ğŸ“… 2026ë…„ 1ì›” ë§¤ì¶œ í˜„í™©</h5>
                    <span class="badge bg-primary fs-6">ì´ ë§¤ì¶œ: <span id="total-revenue">0</span>ì›</span>
                </div>
                <div class="table-responsive" style="height: 75vh;">
                    <table class="table table-bordered table-hover table-sm table-striped">
                        <thead><tr id="date-header"></tr></thead>
                        <tbody id="dashboard-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="db">
                
                <div class="drop-zone" id="dropZone" onclick="document.getElementById('excelUpload').click()">
                    <div class="drop-icon">ğŸ“‚ ğŸ“‚ ğŸ“‚</div>
                    <p>ì—¬ëŸ¬ ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”!</p>
                    <small class="text-muted d-block mt-2">ì¿ íŒ¡, ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´, ì§€ë§ˆì¼“, ì´ë²— íŒŒì¼ ì§€ì›</small>
                    <small class="text-primary fw-bold mt-1 d-block">* ìƒí’ˆëª… ìë™ ë³€í™˜ + ìˆ˜ì§‘ì¼ ìë™ ì¸ì‹</small>
                    <input type="file" id="excelUpload" style="display:none" accept=".xls, .xlsx, .csv" multiple onchange="handleExcelUpload(this.files)">
                </div>

                <div class="input-area" id="inputFormArea">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                        <h6 class="m-0 text-primary" id="formTitle">âœï¸ ë°ì´í„° ì…ë ¥</h6>
                        <button class="btn btn-secondary btn-sm" id="cancelEditBtn" style="display:none;" onclick="cancelEdit()">ì·¨ì†Œ</button>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-2">
                            <label class="form-label">ìˆ˜ì§‘ì¼</label>
                            <input type="date" class="form-control form-control-sm" id="db-date">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì‡¼í•‘ëª°ì´ë¦„</label>
                            <select class="form-select form-select-sm" id="db-mall">
                                <option value="ì¿ íŒ¡ ìœ™">ì¿ íŒ¡ ìœ™</option>
                                <option value="ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤">ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤</option>
                                <option value="ì¿ íŒ¡ ë¡œì¼“ë°°ì†¡">ì¿ íŒ¡ ë¡œì¼“ë°°ì†¡</option>
                                <option value="ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</option>
                                <option value="ì§€ë§ˆì¼“">ì§€ë§ˆì¼“</option>
                                <option value="11ë²ˆê°€">11ë²ˆê°€</option>
                                <option value="(SH)ì¿ íŒ¡ ìœ™">(SH)ì¿ íŒ¡ ìœ™</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ìƒí’ˆëª… (ìë™ì™„ì„±)</label>
                            <input type="text" class="form-control form-control-sm" id="db-product" list="productOptions" placeholder="ìƒí’ˆëª… ì…ë ¥">
                            <datalist id="productOptions"></datalist>
                        </div>
                         <div class="col-md-1">
                            <label class="form-label">íƒë°°ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control form-control-sm" id="db-delivery-qty" value="1" readonly style="background-color:#e9ecef;">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ê²°ì œê¸ˆì•¡</label>
                            <input type="number" class="form-control form-control-sm" id="db-amount" placeholder="ì›">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">íŒë§¤ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control form-control-sm" id="db-sales-qty" value="1">
                        </div>
                    </div>
                    <div class="row g-2 mt-1">
                        <div class="col-md-2">
                            <label class="form-label">ìˆ˜ì·¨ì¸ëª…</label>
                            <input type="text" class="form-control form-control-sm" id="db-receiver">
                        </div>
                         <div class="col-md-2">
                            <label class="form-label">CSêµ¬ë¶„</label>
                            <input type="text" class="form-control form-control-sm" id="db-cs-type">
                        </div>
                         <div class="col-md-5">
                            <label class="form-label">CSì ‘ìˆ˜ë‚´ìš©</label>
                            <input type="text" class="form-control form-control-sm" id="db-cs-content">
                        </div>
                         <div class="col-md-1">
                            <label class="form-label">íšŒìˆ˜ì—¬ë¶€</label>
                            <select class="form-select form-select-sm" id="db-return">
                                <option value="">-</option>
                                <option value="Y">Y</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary btn-sm w-100" id="submitBtn" onclick="addOrUpdateSale()">â• ì¶”ê°€</button>
                        </div>
                    </div>
                </div>

                <div class="input-area p-0">
                    <div class="d-flex justify-content-between p-2 border-bottom bg-light">
                        <span class="fw-bold">ğŸ“‹ ë§¤ì¶œ ì›ì¥</span>
                        <span class="small text-muted align-self-center">ì´ <span id="db-count">0</span>ê±´</span>
                        <button class="btn btn-xs btn-outline-danger" onclick="clearDB()">ì „ì²´ ì‚­ì œ</button>
                    </div>
                    <div class="table-responsive" style="max-height: 50vh;">
                        <table class="table table-bordered table-hover mb-0 text-center table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>ìˆ˜ì§‘ì¼</th>
                                    <th>ì‡¼í•‘ëª°ì´ë¦„</th>
                                    <th>ìƒí’ˆëª…</th>
                                    <th>íƒë°°ìˆ˜ëŸ‰</th>
                                    <th>ê²°ì œê¸ˆì•¡</th>
                                    <th>íŒë§¤ìˆ˜ëŸ‰</th>
                                    <th>ìˆ˜ì·¨ì¸ëª…</th>
                                    <th>CSêµ¬ë¶„</th>
                                    <th>CSì ‘ìˆ˜ë‚´ìš©</th>
                                    <th>íšŒìˆ˜ì—¬ë¶€</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="db-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="ads">
                <div class="input-area">
                    <h5>ğŸ“¢ ì±„ë„ë³„ ê´‘ê³  ì˜ˆì‚°</h5>
                    <table class="table table-bordered table-sm">
                        <thead><tr class="table-secondary"><th>ì±„ë„</th><th>ìœ í˜•</th><th>ì˜ˆì‚°</th><th>ì§‘í–‰ì•¡</th></tr></thead>
                        <tbody id="ads-budget-body"></tbody>
                    </table>
                    <button class="btn btn-primary btn-sm" onclick="saveToStorage()">ì €ì¥</button>
                </div>
            </div>
            <div class="tab-pane fade" id="settlement">
                 <div class="input-area">
                    <h5>ğŸ’° ì›”ë³„ ì •ì‚° í˜„í™©</h5>
                    <table class="table table-bordered table-sm">
                        <thead><tr class="table-secondary"><th>ì±„ë„</th><th>ë‚ ì§œ</th><th>ê¸ˆì•¡</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="settlement-body"></tbody>
                        <tfoot>
                            <tr>
                                <td><input type="text" id="set-channel" class="form-control form-control-sm" placeholder="ì±„ë„"></td>
                                <td><input type="date" id="set-date" class="form-control form-control-sm"></td>
                                <td><input type="number" id="set-amount" class="form-control form-control-sm" placeholder="ê¸ˆì•¡"></td>
                                <td><button class="btn btn-success btn-sm w-100" onclick="addSettlement()">ì¶”ê°€</button></td>
                            </tr>
                        </tfoot>
                    </table>
                 </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const CHANNELS = ['ì¿ íŒ¡ ìœ™', 'ì¿ íŒ¡ ë¡œì¼“ë°°ì†¡', 'ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤', 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´', 'ì§€ë§ˆì¼“', '11ë²ˆê°€', '(SH)ì¿ íŒ¡ ìœ™'];
        let TARGETS = {'ì¿ íŒ¡ ìœ™': 10000000, 'ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤': 24000000, 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´': 3000000};
        
        // --- 1. ë§¤ì¹­ ë£° ì •ì˜ (í‚¤ì›Œë“œ ê¸°ë°˜ ì •ë°€ ë§¤ì¹­) ---
        const MATCHING_RULES = [
            { target: "ì  ë°”ë”” ì½”ë¡œë‚˜ ìê°€ê²€ì‚¬í‚¤íŠ¸ / 2ê°œì…", keywords: ["ì  ë°”ë””", "2ê°œ"] },
            { target: "ì  ë°”ë”” ì½”ë¡œë‚˜ ìê°€ê²€ì‚¬í‚¤íŠ¸ / 2ê°œì…", keywords: ["ì  ë°”ë””", "2ì…"] },
            
            { target: "ìºì¹˜í‹°ë‹ˆí•‘ ì‹œì¦Œ3 ë§ˆìŠ¤í¬ ì†Œí˜•XS í•˜ì¸„í•‘", keywords: ["ë§ˆìŠ¤í¬", "í•˜ì¸„í•‘"] },
            { target: "ìºì¹˜í‹°ë‹ˆí•‘ ì‹œì¦Œ3 ë§ˆìŠ¤í¬ ì†Œí˜•XS í•˜ì¸„í•‘", keywords: ["ë§ˆìŠ¤í¬", "í‹°ë‹ˆí•‘"] }, // ê¸°ë³¸ ë§ˆìŠ¤í¬

            // êµì •ì “ê°€ë½ (ë¬´ì†ŒìŒ vs ì˜¬ì¸ì› êµ¬ë¶„)
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ë¬´ì†ŒìŒ êµì •ì “ê°€ë½ í’€ì„¸íŠ¸-ì˜¤ë¡œë¼í•‘", keywords: ["ë¬´ì†ŒìŒ", "ì˜¤ë¡œë¼"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ë¬´ì†ŒìŒ êµì •ì “ê°€ë½ í’€ì„¸íŠ¸-ì™•ìí•‘", keywords: ["ë¬´ì†ŒìŒ", "ì™•ì"] },
            
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ë¹›ë‚˜í•‘", keywords: ["ì˜¬ì¸ì›", "ë¹›ë‚˜"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ì´ˆë¡±í•‘", keywords: ["ì˜¬ì¸ì›", "ì´ˆë¡±"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ë°˜ì§í•‘", keywords: ["ì˜¬ì¸ì›", "ë°˜ì§"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ì™•ìí•‘", keywords: ["ì˜¬ì¸ì›", "ì™•ì"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ì˜¤ë¡œë¼í•‘", keywords: ["ì˜¬ì¸ì›", "ì˜¤ë¡œë¼"] },
            
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì‹œì¦Œ5 / í•œê¸€ìì„í”ŒëŸ¬ìŠ¤", keywords: ["í•œê¸€", "ìì„"] },
            
            // ìœ„ì‹œìº£
            { target: "ìœ„ì‹œìº£ í•˜íŠ¸ ì†ì¡ì´ / ë³´í‹€", keywords: ["ìœ„ì‹œìº£", "ì†ì¡ì´"] },
            { target: "ìœ„ì‹œìº£ ì•ˆì‹¬ë½ ìŠ¤íŠ¸ë© / ë³´í‹€", keywords: ["ìœ„ì‹œìº£", "ìŠ¤íŠ¸ë©"] },
            { target: "ìœ„ì‹œìº£ ì•ˆì‹¬ë½ ìŠ¤íŠ¸ë© / ë³´í‹€", keywords: ["ìœ„ì‹œìº£", "ì•ˆì‹¬ë½"] },
            
            // í•˜ì¸„í•‘ ë°©í•œìš©í’ˆ (ëª©ë„ë¦¬ vs ì¥ê°‘ ì •ë°€ êµ¬ë¶„)
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-ëª¨ìëª©ë„ë¦¬", keywords: ["ëª¨ì", "ëª©ë„ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-íŒ¨ë”©ëª©ë„ë¦¬", keywords: ["íŒ¨ë”©", "ëª©ë„ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-í„¸ëª©ë„ë¦¬", keywords: ["í„¸", "ëª©ë„ë¦¬"] },
            
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-íŒ¨ë”©ë²™ì–´ë¦¬ì¥ê°‘", keywords: ["íŒ¨ë”©", "ë²™ì–´ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-í„¸ë²™ì–´ë¦¬ì¥ê°‘", keywords: ["í„¸", "ë²™ì–´ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-ìŠ¤í‚¤ì¥ê°‘", keywords: ["ìŠ¤í‚¤"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-ë² ì´ì§ì†ê°€ë½ì¥ê°‘", keywords: ["ì†ê°€ë½"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-ë² ì´ì§ì†ê°€ë½ì¥ê°‘", keywords: ["ë² ì´ì§"] },
            
            // ì°¸ì¡´ ë§ˆìŠ¤í¬
            { target: "ì°¸ì¡´ KF94 í†¤ì—…í• ë¸”ë™ë¼ë²¨ ë¼ì´íŠ¸ ë§ˆìŠ¤í¬ ì¤‘í˜• 25ê°œì…-ë°”ë‹ë¼ë² ì´ì§€", keywords: ["ë°”ë‹ë¼"] },
            { target: "ì°¸ì¡´ KF94 í†¤ì—…í• ë¸”ë™ë¼ë²¨ ë¼ì´íŠ¸ ë§ˆìŠ¤í¬ ì¤‘í˜• 25ê°œì…-ë¬´ë“œê·¸ë ˆì´", keywords: ["ê·¸ë ˆì´"] },
            { target: "ì°¸ì¡´ í†¤ì—…í• ë§ˆìŠ¤í¬ ëŒ€í˜• 25ê°œì…-ì½”ë„", keywords: ["ì½”ë„"] },
            { target: "ì°¸ì¡´ í†¤ì—…í• ë§ˆìŠ¤í¬ ëŒ€í˜• 25ê°œì…-ëˆ„ë“œì—…ë² ì´ì§€", keywords: ["ëˆ„ë“œ"] }
        ];

        let dbData = [], adData = [], settlementData = [];
        let editingIndex = -1;

        window.onload = function() {
            loadFromStorage();
            document.getElementById('db-date').value = new Date().toISOString().substring(0,10);
            
            // ìë™ì™„ì„± ëª©ë¡ ìƒì„±
            const uniqueTargets = [...new Set(MATCHING_RULES.map(r => r.target))];
            const datalist = document.getElementById('productOptions');
            uniqueTargets.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                datalist.appendChild(option);
            });
            
            setupDropZone();
            refreshAll();
        };

        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault(); dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleExcelUpload(e.dataTransfer.files);
            });
        }

        function refreshAll() { renderDashboard(); renderDB(); renderAds(); renderSettlement(); }

        // --- 2. í¼í™íŠ¸ ë§¤ì¹­ í•¨ìˆ˜ ---
        function normalizeProductName(rawName) {
            if(!rawName) return "";
            // ê³µë°± ì œê±° ë° ì†Œë¬¸ì ë³€í™˜ í›„ ë¹„êµ (ì •í™•ë„ í–¥ìƒ)
            const cleanName = rawName.replace(/\s+/g, '').toLowerCase();
            
            for (let rule of MATCHING_RULES) {
                // ëª¨ë“  í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                const allMatch = rule.keywords.every(k => cleanName.includes(k.replace(/\s+/g, '').toLowerCase()));
                if (allMatch) return rule.target;
            }
            return rawName; // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ìœ ì§€
        }

        async function handleExcelUpload(files) {
            if(files.length === 0) return;
            let totalSuccess = 0;
            let totalFiles = files.length;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // íŒŒì¼ ìˆ˜ì • ë‚ ì§œë¥¼ ìˆ˜ì§‘ì¼ë¡œ ì‚¬ìš©
                const fileDate = new Date(file.lastModified);
                const dateStr = fileDate.toISOString().substring(0,10);

                try {
                    const count = await processSingleFile(file, dateStr);
                    totalSuccess += count;
                } catch (e) { console.error(`${file.name} ì˜¤ë¥˜:`, e); }
            }

            saveToStorage();
            refreshAll();
            alert(`ì´ ${totalFiles}ê°œ íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ!\nâœ… ${totalSuccess}ê±´ ë“±ë¡ ì„±ê³µ`);
            document.getElementById('excelUpload').value = '';
        }

        function processSingleFile(file, dateStr) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                        if(jsonData.length < 1) { resolve(0); return; }

                        let headerRow = -1, platform = 'UNKNOWN', colMap = {};
                        for(let r=0; r<Math.min(5, jsonData.length); r++) {
                            const rowStr = JSON.stringify(jsonData[r]);
                            if(rowStr.includes('ìƒí’ˆì£¼ë¬¸ë²ˆí˜¸') && rowStr.includes('ì£¼ë¬¸ ìœ ì…ê²½ë¡œ')) { headerRow = r; platform = 'SMARTSTORE'; break; } 
                            else if(rowStr.includes('ë“±ë¡ìƒí’ˆëª…') && rowStr.includes('ë…¸ì¶œìƒí’ˆëª…')) { headerRow = r; platform = 'COUPANG'; break; } 
                            else if(rowStr.includes('íŒë§¤ì•„ì´ë””') && rowStr.includes('ë°œì†¡ë§ˆê°ì¼')) { headerRow = r; platform = 'GMARKET'; break; } 
                            else if(rowStr.includes('ì£¼ë¬¸ë²ˆí˜¸') && rowStr.includes('ì˜µì…˜ëª…')) { headerRow = r; platform = 'EBOT'; break; }
                        }

                        if(headerRow === -1) { resolve(0); return; }
                        jsonData[headerRow].forEach((col, idx) => { if(col) colMap[col.trim()] = idx; });
                        
                        let successCount = 0;
                        for(let i = headerRow + 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if(!row || row.length === 0) continue;

                            let newOrder = {
                                date: dateStr, mall: '', product: '', deliveryQty: 1, amount: 0,
                                salesQty: 1, receiver: '', csType: '', csContent: '', returnStatus: '', rawId: ''
                            };
                            let rawProductName = "";

                            if(platform === 'SMARTSTORE') {
                                if(!row[colMap['ìƒí’ˆì£¼ë¬¸ë²ˆí˜¸']]) continue;
                                newOrder.mall = 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´';
                                newOrder.rawId = row[colMap['ìƒí’ˆì£¼ë¬¸ë²ˆí˜¸']];
                                rawProductName = row[colMap['ìƒí’ˆëª…']] + (row[colMap['ì˜µì…˜ì •ë³´']] ? ' ' + row[colMap['ì˜µì…˜ì •ë³´']] : '');
                                newOrder.amount = Number(row[colMap['ìµœì¢… ìƒí’ˆë³„ ì´ ì£¼ë¬¸ê¸ˆì•¡']] || row[colMap['ìƒí’ˆê°€ê²©']] || 0);
                                newOrder.salesQty = Number(row[colMap['ìˆ˜ëŸ‰']] || 1);
                                newOrder.receiver = row[colMap['ìˆ˜ì·¨ì¸ëª…']];
                            } else if (platform === 'COUPANG') {
                                if(!row[colMap['ì£¼ë¬¸ë²ˆí˜¸']]) continue;
                                newOrder.mall = 'ì¿ íŒ¡ ìœ™';
                                newOrder.rawId = row[colMap['ì£¼ë¬¸ë²ˆí˜¸']];
                                rawProductName = row[colMap['ë“±ë¡ìƒí’ˆëª…']] || row[colMap['ë…¸ì¶œìƒí’ˆëª…']];
                                let price = Number(row[colMap['ê²°ì œì•¡']]);
                                if(!price) price = Number(row[colMap['ì˜µì…˜íŒë§¤ê°€(íŒë§¤ë‹¨ê°€)']]) * Number(row[colMap['êµ¬ë§¤ìˆ˜(ìˆ˜ëŸ‰)']]);
                                newOrder.amount = price || 0;
                                newOrder.salesQty = Number(row[colMap['êµ¬ë§¤ìˆ˜(ìˆ˜ëŸ‰)']] || 1);
                                newOrder.receiver = row[colMap['ìˆ˜ì·¨ì¸ì´ë¦„']] || row[colMap['êµ¬ë§¤ìì´ë¦„']];
                            } else if (platform === 'GMARKET') {
                                if(!row[colMap['ì£¼ë¬¸ë²ˆí˜¸']]) continue;
                                newOrder.mall = 'ì§€ë§ˆì¼“';
                                newOrder.rawId = row[colMap['ì£¼ë¬¸ë²ˆí˜¸']];
                                rawProductName = row[colMap['ìƒí’ˆëª…']];
                                newOrder.amount = Number(row[colMap['íŒë§¤ê¸ˆì•¡']] || (row[colMap['íŒë§¤ë‹¨ê°€']] * row[colMap['ìˆ˜ëŸ‰']]) || 0);
                                newOrder.salesQty = Number(row[colMap['ìˆ˜ëŸ‰']] || 1);
                                newOrder.receiver = row[colMap['ìˆ˜ë ¹ì¸ëª…']];
                            } else if (platform === 'EBOT') {
                                if(!row[colMap['ì£¼ë¬¸ë²ˆí˜¸']]) continue;
                                newOrder.mall = row[colMap['ì£¼ë¬¸ë²ˆí˜¸']] === 'ì¿ íŒ¡ìœ™' ? 'ì¿ íŒ¡ ìœ™' : row[colMap['ì£¼ë¬¸ë²ˆí˜¸']];
                                newOrder.rawId = row[colMap['ì†¡ì¥ë²ˆí˜¸']] || row[colMap['ì£¼ë¬¸ë²ˆí˜¸']];
                                rawProductName = row[colMap['ìƒí’ˆëª…']] + (row[colMap['ì˜µì…˜ëª…']] ? ' ' + row[colMap['ì˜µì…˜ëª…']] : '');
                                newOrder.amount = Number(row[colMap['íŒë§¤ê¸ˆì•¡']] || 0);
                                newOrder.salesQty = Number(row[colMap['ìˆ˜ëŸ‰']] || 1);
                                newOrder.receiver = row[colMap['ìˆ˜ë ¹ì']];
                            }

                            // ìƒí’ˆëª… ì •ê·œí™” ì ìš©
                            newOrder.product = normalizeProductName(rawProductName);
                            newOrder.deliveryQty = 1; // íƒë°°ìˆ˜ëŸ‰ 1 ê³ ì •

                            if(!dbData.some(d => d.rawId == newOrder.rawId)) {
                                dbData.push(newOrder);
                                successCount++;
                            }
                        }
                        resolve(successCount);
                    } catch(err) { reject(err); }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // --- ë Œë”ë§ ë° ìœ í‹¸ ---
        function renderDashboard() {
            const thead = document.getElementById('date-header');
            const tbody = document.getElementById('dashboard-body');
            let html = '<th class="bg-light sticky-col">ì±„ë„</th><th class="bg-light">ëª©í‘œ</th><th class="bg-light">í•©ê³„</th><th class="bg-light">ë‹¬ì„±ë¥ </th>';
            for(let i=1; i<=31; i++) html += `<th>${i}ì¼</th>`;
            thead.innerHTML = html;
            tbody.innerHTML = '';
            CHANNELS.forEach(ch => {
                let total = 0;
                let cells = '';
                for(let i=1; i<=31; i++) {
                    const dt = `2026-01-${String(i).padStart(2,'0')}`;
                    const sum = dbData.filter(d => d.date === dt && d.mall === ch).reduce((a,c) => a+c.amount, 0);
                    total += sum;
                    cells += `<td class="text-end">${sum ? sum.toLocaleString() : '-'}</td>`;
                }
                const target = TARGETS[ch] || 0;
                const rate = target ? (total/target*100).toFixed(1)+'%' : '-';
                tbody.innerHTML += `<tr><td class="fw-bold bg-white" style="position:sticky; left:0;">${ch}</td><td class="text-end text-secondary">${target.toLocaleString()}</td><td class="text-end fw-bold text-primary">${total.toLocaleString()}</td><td class="text-center small">${rate}</td>${cells}</tr>`;
            });
        }
        function renderDB() {
            const tbody = document.getElementById('db-body'); tbody.innerHTML = '';
            const indexedData = dbData.map((item, idx) => ({...item, originalIndex: idx}));
            indexedData.sort((a,b) => new Date(b.date) - new Date(a.date));
            indexedData.forEach((item) => {
                tbody.innerHTML += `<tr>
                    <td>${item.date}</td><td>${item.mall}</td><td class="text-start">${item.product}</td>
                    <td>${item.deliveryQty}</td><td class="text-end fw-bold">${item.amount.toLocaleString()}</td>
                    <td>${item.salesQty}</td><td>${item.receiver}</td><td>${item.csType||''}</td><td>${item.csContent||''}</td><td>${item.returnStatus||''}</td>
                    <td><button class="btn btn-xs btn-outline-primary py-0 me-1" onclick="editSale(${item.originalIndex})">ìˆ˜ì •</button><button class="btn btn-xs btn-outline-danger py-0" onclick="deleteDB(${item.originalIndex})">ì‚­ì œ</button></td>
                </tr>`;
            });
            document.getElementById('db-count').innerText = dbData.length;
        }
        function editSale(index) {
            editingIndex = index; const item = dbData[index];
            document.getElementById('db-date').value = item.date; document.getElementById('db-mall').value = item.mall; document.getElementById('db-product').value = item.product;
            document.getElementById('db-amount').value = item.amount; document.getElementById('db-sales-qty').value = item.salesQty; document.getElementById('db-receiver').value = item.receiver;
            document.getElementById('db-cs-type').value = item.csType||''; document.getElementById('db-cs-content').value = item.csContent||''; document.getElementById('db-return').value = item.returnStatus||'';
            document.getElementById('formTitle').innerText = "âœï¸ ìˆ˜ì • ì¤‘..."; document.getElementById('submitBtn').innerText = "ğŸ’¾ ì €ì¥"; document.getElementById('submitBtn').classList.replace('btn-primary', 'btn-success');
            document.getElementById('cancelEditBtn').style.display = 'block'; document.getElementById('inputFormArea').classList.add('editing-mode'); document.getElementById('inputFormArea').scrollIntoView({ behavior: 'smooth' });
        }
        function cancelEdit() {
            editingIndex = -1; document.getElementById('db-product').value = ''; document.getElementById('db-amount').value = ''; document.getElementById('db-receiver').value = '';
            document.getElementById('db-cs-type').value = ''; document.getElementById('db-cs-content').value = ''; document.getElementById('db-return').value = '';
            document.getElementById('formTitle').innerText = "âœï¸ ë°ì´í„° ì…ë ¥"; document.getElementById('submitBtn').innerText = "â• ì¶”ê°€"; document.getElementById('submitBtn').classList.replace('btn-success', 'btn-primary');
            document.getElementById('cancelEditBtn').style.display = 'none'; document.getElementById('inputFormArea').classList.remove('editing-mode');
        }
        function addOrUpdateSale() {
            const date = document.getElementById('db-date').value; const amount = document.getElementById('db-amount').value;
            if(!date || !amount) return alert('ë‚ ì§œ/ê¸ˆì•¡ í•„ìˆ˜');
            const newItem = {
                date: date, mall: document.getElementById('db-mall').value, product: document.getElementById('db-product').value,
                deliveryQty: 1, amount: Number(amount), salesQty: Number(document.getElementById('db-sales-qty').value),
                receiver: document.getElementById('db-receiver').value, csType: document.getElementById('db-cs-type').value,
                csContent: document.getElementById('db-cs-content').value, returnStatus: document.getElementById('db-return').value,
                rawId: editingIndex > -1 ? dbData[editingIndex].rawId : ('MANUAL-'+Date.now())
            };
            if(editingIndex > -1) { dbData[editingIndex] = newItem; alert('ìˆ˜ì •ì™„ë£Œ'); cancelEdit(); } else { dbData.push(newItem); document.getElementById('db-product').value=''; document.getElementById('db-amount').value=''; }
            saveToStorage(); refreshAll();
        }
        function deleteDB(idx) { if(confirm('ì‚­ì œ?')) { dbData.splice(idx, 1); saveToStorage(); refreshAll(); } }
        function clearDB() { if(confirm('ì „ì²´ì‚­ì œ?')) { dbData=[]; saveToStorage(); refreshAll(); } }
        function saveToStorage() { localStorage.setItem('sh_sales_v10', JSON.stringify({ db: dbData, ads: adData, settlement: settlementData })); }
        function loadFromStorage() { const s = localStorage.getItem('sh_sales_v10'); if(s) { const p=JSON.parse(s); dbData=p.db||[]; adData=p.ads||[]; settlementData=p.settlement||[]; } else { adData = [{channel: 'ì¿ íŒ¡ ìœ™', type: 'CPC', budget: 961417, spent: 0}, {channel: 'ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤', type: 'CPC', budget: 334404, spent: 0}]; } }
        function renderAds() { const t = document.getElementById('ads-budget-body'); t.innerHTML = ''; adData.forEach((d,i) => t.innerHTML += `<tr><td>${d.channel}</td><td>${d.type}</td><td><input type="number" class="form-control form-control-sm text-end" value="${d.budget}" onchange="adData[${i}].budget=Number(this.value)"></td><td><input type="number" class="form-control form-control-sm text-end" value="${d.spent}" onchange="adData[${i}].spent=Number(this.value)"></td></tr>`); }
        function renderSettlement() { const t = document.getElementById('settlement-body'); t.innerHTML = ''; settlementData.forEach((d,i) => t.innerHTML += `<tr><td>${d.channel}</td><td>${d.date}</td><td class="text-end">${Number(d.amount).toLocaleString()}</td><td><button class="btn btn-xs btn-outline-danger" onclick="settlementData.splice(${i},1);saveToStorage();refreshAll()">ì‚­ì œ</button></td></tr>`); }
        function addSettlement() { settlementData.push({channel:document.getElementById('set-channel').value, date:document.getElementById('set-date').value, amount:document.getElementById('set-amount').value}); saveToStorage(); refreshAll(); }
        function downloadData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem('sh_sales_v10')); a.download = "SH_ë§¤ì¶œë°±ì—….json"; a.click(); }
        function loadDataFromBackup(input) { const r = new FileReader(); r.onload = e => { localStorage.setItem('sh_sales_v10', e.target.result); location.reload(); }; r.readAsText(input.files[0]); }
        function resetData() { if(confirm('ì´ˆê¸°í™”?')) { localStorage.removeItem('sh_sales_v10'); location.reload(); } }
    </script>
</body>
</html>
