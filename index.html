<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJ Innovation í†µí•© ë§¤ì¶œ ì‹œìŠ¤í…œ (Ver 36.1)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f8f9fa; font-size: 0.85rem; }
        .header { background-color: #2c3e50; color: white; padding: 15px; margin-bottom: 15px; }
        .nav-tabs .nav-link.active { font-weight: bold; border-top: 3px solid #0d6efd; }
        .table-responsive { overflow-x: auto; white-space: nowrap; margin-bottom: 20px; background: white; border: 1px solid #dee2e6; border-radius: 5px; }
        .table th { background-color: #e9ecef; vertical-align: middle; text-align: center; white-space: nowrap; font-size: 0.8rem; }
        .table td { vertical-align: middle; padding: 4px 8px; white-space: nowrap; font-size: 0.8rem; }
        .input-area { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; border: 1px solid #dee2e6; }
        .form-label { font-weight: bold; font-size: 0.8rem; margin-bottom: 2px; color: #495057; }
        .drop-zone { border: 2px dashed #0d6efd; border-radius: 10px; padding: 30px; text-align: center; background-color: #f8f9fa; cursor: pointer; margin-bottom: 15px; transition: all 0.3s; }
        .drop-zone:hover { background-color: #e7f1ff; border-color: #0b5ed7; }
        .drop-icon { font-size: 2.5rem; color: #0d6efd; margin-bottom: 10px; }
        .chart-container { position: relative; height: 400px; width: 100%; margin-top: 20px; }
        .month-header { 
            font-size: 1.1rem; font-weight: bold; color: #2c3e50; 
            margin-bottom: 10px; border-left: 5px solid #0d6efd; 
            padding: 10px; display: flex; justify-content: space-between; align-items: center; 
            background-color: #e9ecef; border-radius: 0 5px 5px 0; height: 45px;
        }
        .fw-bold-total { font-weight: 800; color: #0d6efd; }
    </style>
</head>
<body>

    <div class="header">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div>
                <h4 class="m-0">ğŸ“Š SJ Innovation ë§¤ì¶œ ì‹œìŠ¤í…œ</h4>
                <small class="text-light opacity-75">Ver 36.1: ë°±ì—… ë°ì´í„° ë‚´ ì‹œì¦Œ6 ìƒí’ˆëª… ì¼ê´„ ìˆ˜ì • ì ìš©</small>
            </div>
            <div>
                <button class="btn btn-success btn-sm fw-bold me-2" onclick="exportReportToExcel()">ğŸ“‘ ë³´ê³ ì„œ ë‹¤ìš´ (ìµœì¢…)</button>
                <button class="btn btn-outline-light btn-sm" onclick="downloadData()">ğŸ’¾ ë°±ì—… ì €ì¥</button>
                <button class="btn btn-outline-light btn-sm" onclick="document.getElementById('backupInput').click()">ğŸ“‚ ë°±ì—… ë³µì›</button>
                <input type="file" id="backupInput" style="display:none" onchange="loadDataFromBackup(this)">
                <button class="btn btn-danger btn-sm ms-2" onclick="resetData()"> ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">ğŸ“ˆ ëŒ€ì‹œë³´ë“œ</button></li>
            <li class="nav-item"><button class="nav-link" id="db-tab" data-bs-toggle="tab" data-bs-target="#db" type="button">ğŸ“ ë§¤ì¶œ ë“±ë¡ (DB)</button></li>
        </ul>

        <div class="tab-content p-3 bg-white border border-top-0 rounded-bottom shadow-sm">
            <div class="tab-pane fade show active" id="dashboard">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 id="dash-title" class="m-0 fw-bold">ğŸ“… 2026ë…„ ì „ì²´ ë§¤ì¶œ í˜„í™©</h5>
                    <span class="badge bg-primary fs-6">ì—°ê°„ ì´ ë§¤ì¶œ: <span id="total-year-revenue">0</span>ì›</span>
                </div>
                <div id="monthly-tables-container" style="height: 65vh; overflow-y: auto; padding-right: 10px;"></div>
                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="card-title fw-bold text-secondary">ğŸ“Š <span id="chart-year">2026ë…„</span> ì—°ê°„ ì¸ê¸° ìƒí’ˆ TOP 5</h6>
                        <div class="chart-container"><canvas id="salesChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="db">
                <div class="drop-zone" id="dropZone" onclick="document.getElementById('excelUpload').click()">
                    <div class="drop-icon">ğŸ“‚ ğŸ“‚ ğŸ“‚</div>
                    <p>ëª¨ë“  ì—‘ì…€ íŒŒì¼ ë“œë˜ê·¸ (ìì‚¬ì–‘ì‹, ë¡œì¼“ê·¸ë¡œìŠ¤, ì¿ íŒ¡ ë“±)</p>
                    <p class="info-text mt-2 text-primary fw-bold">â€» 0ì›/ë§ˆì´ë„ˆìŠ¤ ì œì™¸ + ì‹œì¦Œ6 ìƒí’ˆëª… ìë™ ì •ë¦¬</p>
                    <input type="file" id="excelUpload" style="display:none" accept=".xls, .xlsx, .csv" multiple onchange="handleExcelUpload(this.files)">
                </div>
                <div class="input-area" id="inputFormArea">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                        <h6 class="m-0 text-primary">âœï¸ ë°ì´í„° ì…ë ¥ & ì¡°íšŒ</h6>
                        <button class="btn btn-secondary btn-sm" id="cancelEditBtn" style="display:none;" onclick="cancelEdit()">ì·¨ì†Œ</button>
                    </div>
                    <div class="row g-2 mb-3 bg-light p-2 rounded border">
                        <div class="col-md-2 d-flex align-items-center"><span class="fw-bold me-2">ğŸ” ì¡°íšŒ í•„í„°:</span></div>
                        <div class="col-md-2"><select class="form-select form-select-sm" id="filter-year" onchange="renderDB()"><option value="2025">2025ë…„</option><option value="2026" selected>2026ë…„</option><option value="2027">2027ë…„</option></select></div>
                        <div class="col-md-2"><select class="form-select form-select-sm" id="filter-month" onchange="renderDB()"><option value="all">ì „ì²´ ì›”</option><option value="01">1ì›”</option><option value="02">2ì›”</option><option value="03">3ì›”</option><option value="04">4ì›”</option><option value="05">5ì›”</option><option value="06">6ì›”</option><option value="07">7ì›”</option><option value="08">8ì›”</option><option value="09">9ì›”</option><option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option></select></div>
                        <div class="col-md-2"><button class="btn btn-sm btn-outline-secondary w-100" onclick="resetFilter()">ì „ì²´ ë³´ê¸°</button></div>
                        <div class="col-md-4 text-end"><span class="small text-muted" id="filter-info"></span></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-3"><label class="form-label text-danger">ê¸°ì¤€ ì—°ë„/ì›” (ë³´ê³ ì„œìš©)</label><div class="input-group input-group-sm"><div class="input-group-text"><input class="form-check-input mt-0" type="checkbox" id="force-date-check"><span class="ms-1 small">ê°•ì œ</span></div><input type="date" class="form-control" id="db-date" onchange="renderDashboard()"></div></div>
                        <div class="col-md-2"><label class="form-label">ì‡¼í•‘ëª°</label><select class="form-select form-select-sm" id="db-mall"><option value="ì¿ íŒ¡ ìœ™">ì¿ íŒ¡ ìœ™</option><option value="ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤">ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤</option><option value="ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</option><option value="ì§€ë§ˆì¼“">ì§€ë§ˆì¼“</option><option value="11ë²ˆê°€">11ë²ˆê°€</option><option value="(SH)ì¿ íŒ¡ ìœ™">(SH)ì¿ íŒ¡ ìœ™</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
                        <div class="col-md-4"><label class="form-label">ìƒí’ˆëª…</label><input type="text" class="form-control form-control-sm" id="db-product" list="productOptions"><datalist id="productOptions"></datalist></div>
                        <div class="col-md-1"><label class="form-label">íƒë°°ìˆ˜ëŸ‰</label><input type="number" class="form-control form-control-sm" id="db-delivery-qty" value="1" readonly style="background-color:#e9ecef;"></div>
                        <div class="col-md-2"><label class="form-label">ê²°ì œê¸ˆì•¡</label><input type="number" class="form-control form-control-sm" id="db-amount"></div>
                        <div class="col-md-1"><label class="form-label">íŒë§¤ìˆ˜ëŸ‰</label><input type="number" class="form-control form-control-sm" id="db-sales-qty" value="1"></div>
                    </div>
                    <div class="row g-2 mt-1">
                        <div class="col-md-2"><label class="form-label">ìˆ˜ì·¨ì¸ëª…</label><input type="text" class="form-control form-control-sm" id="db-receiver"></div>
                        <div class="col-md-2"><label class="form-label">CSêµ¬ë¶„</label><input type="text" class="form-control form-control-sm" id="db-cs-type"></div>
                        <div class="col-md-5"><label class="form-label">CSì ‘ìˆ˜ë‚´ìš©</label><input type="text" class="form-control form-control-sm" id="db-cs-content"></div>
                        <div class="col-md-1"><label class="form-label">íšŒìˆ˜ì—¬ë¶€</label><select class="form-select form-select-sm" id="db-return"><option value="">-</option><option value="Y">Y</option><option value="N">N</option></select></div>
                        <div class="col-md-2"><label class="form-label">&nbsp;</label><button class="btn btn-primary btn-sm w-100" id="submitBtn" onclick="addOrUpdateSale()">â• ì¶”ê°€</button></div>
                    </div>
                </div>
                <div class="input-area p-0">
                    <div class="d-flex justify-content-between p-2 border-bottom bg-light">
                        <span class="fw-bold">ğŸ“‹ <span id="db-list-title">ì „ì²´</span> ë§¤ì¶œ ë¦¬ìŠ¤íŠ¸</span>
                        <span class="small text-muted align-self-center">ì´ <span id="db-count">0</span>ê±´</span>
                        <button class="btn btn-xs btn-outline-danger" onclick="clearDB()">ì „ì²´ ì‚­ì œ</button>
                    </div>
                    <div class="table-responsive" style="max-height: 50vh;">
                        <table class="table table-bordered table-hover mb-0 text-center table-sm">
                            <thead class="table-light">
                                <tr><th>ìˆ˜ì§‘ì¼</th><th>ì‡¼í•‘ëª°ì´ë¦„</th><th>ìƒí’ˆëª…</th><th>íƒë°°ìˆ˜ëŸ‰</th><th>ê²°ì œê¸ˆì•¡</th><th>íŒë§¤ìˆ˜ëŸ‰</th><th>ìˆ˜ì·¨ì¸ëª…</th><th>CSêµ¬ë¶„</th><th>CSì ‘ìˆ˜ë‚´ìš©</th><th>íšŒìˆ˜ì—¬ë¶€</th><th>ê´€ë¦¬</th></tr>
                            </thead>
                            <tbody id="db-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="hiddenReportChart" style="display:none;"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const CHANNELS = ['ì¿ íŒ¡ ìœ™', 'ì¿ íŒ¡ ë¡œì¼“ë°°ì†¡', 'ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤', 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´', 'ì§€ë§ˆì¼“', '11ë²ˆê°€', '(SH)ì¿ íŒ¡ ìœ™'];
        const MATCHING_RULES = [
            // ê¸°ì¡´ ì œí’ˆë“¤
            { target: "ë¸Œë ˆì¸ë¡¯ ëœë¤ë”±ì§€ íŒŒìš°ì¹˜", keywords: ["ë¸Œë ˆì¸ë¡¯"] },
            { target: "ì  ë°”ë”” ì½”ë¡œë‚˜ ìê°€ê²€ì‚¬í‚¤íŠ¸ / 2ê°œì…", keywords: ["ì  ë°”ë””", "2ê°œ"] },
            { target: "ì  ë°”ë”” ì½”ë¡œë‚˜ ìê°€ê²€ì‚¬í‚¤íŠ¸ / 2ê°œì…", keywords: ["ì  ë°”ë””", "2ì…"] },
            { target: "ìºì¹˜í‹°ë‹ˆí•‘ ì‹œì¦Œ3 ë§ˆìŠ¤í¬ ì†Œí˜•XS í•˜ì¸„í•‘", keywords: ["ë§ˆìŠ¤í¬", "í•˜ì¸„í•‘"] },
            { target: "ìºì¹˜í‹°ë‹ˆí•‘ ì‹œì¦Œ3 ë§ˆìŠ¤í¬ ì†Œí˜•XS í•˜ì¸„í•‘", keywords: ["ë§ˆìŠ¤í¬", "í‹°ë‹ˆí•‘"] }, 
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ë¬´ì†ŒìŒ êµì •ì “ê°€ë½ í’€ì„¸íŠ¸-ì˜¤ë¡œë¼í•‘", keywords: ["ë¬´ì†ŒìŒ", "ì˜¤ë¡œë¼"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ë¬´ì†ŒìŒ êµì •ì “ê°€ë½ í’€ì„¸íŠ¸-ì™•ìí•‘", keywords: ["ë¬´ì†ŒìŒ", "ì™•ì"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ë¹›ë‚˜í•‘", keywords: ["ì˜¬ì¸ì›", "ë¹›ë‚˜"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ì´ˆë¡±í•‘", keywords: ["ì˜¬ì¸ì›", "ì´ˆë¡±"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ë°˜ì§í•‘", keywords: ["ì˜¬ì¸ì›", "ë°˜ì§"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ë°˜ì§í•‘", keywords: ["ì˜¬ì¸ì›", "ë¹¤ì§"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ì™•ìí•‘", keywords: ["ì˜¬ì¸ì›", "ì™•ì"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì˜¬ì¸ì› êµì •ì “ê°€ë½ ì„¸íŠ¸-ì˜¤ë¡œë¼í•‘", keywords: ["ì˜¬ì¸ì›", "ì˜¤ë¡œë¼"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ ì‹œì¦Œ5 / í•œê¸€ìì„í”ŒëŸ¬ìŠ¤", keywords: ["í•œê¸€", "ìì„"] },
            { target: "ìœ„ì‹œìº£ í•˜íŠ¸ ì†ì¡ì´ / ë³´í‹€", keywords: ["ìœ„ì‹œìº£", "ì†ì¡ì´"] },
            { target: "ìœ„ì‹œìº£ ì•ˆì‹¬ë½ ìŠ¤íŠ¸ë© / ë³´í‹€", keywords: ["ìœ„ì‹œìº£", "ìŠ¤íŠ¸ë©"] },
            { target: "ìœ„ì‹œìº£ ì•ˆì‹¬ë½ ìŠ¤íŠ¸ë© / ë³´í‹€", keywords: ["ìœ„ì‹œìº£", "ì•ˆì‹¬ë½"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-ëª¨ìëª©ë„ë¦¬", keywords: ["ëª¨ì", "ëª©ë„ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-íŒ¨ë”©ëª©ë„ë¦¬", keywords: ["íŒ¨ë”©", "ëª©ë„ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-í„¸ëª©ë„ë¦¬", keywords: ["í„¸", "ëª©ë„ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-íŒ¨ë”©ë²™ì–´ë¦¬ì¥ê°‘", keywords: ["íŒ¨ë”©", "ë²™ì–´ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-í„¸ë²™ì–´ë¦¬ì¥ê°‘", keywords: ["í„¸", "ë²™ì–´ë¦¬"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-ìŠ¤í‚¤ì¥ê°‘", keywords: ["ìŠ¤í‚¤"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-ë² ì´ì§ì†ê°€ë½ì¥ê°‘", keywords: ["ì†ê°€ë½"] },
            { target: "ìŠˆíŒ…ìŠ¤íƒ€ ìºì¹˜í‹°ë‹ˆí•‘ í•˜ì¸„í•‘-ë² ì´ì§ì†ê°€ë½ì¥ê°‘", keywords: ["ë² ì´ì§"] },
            { target: "ì°¸ì¡´ KF94 í†¤ì—…í• ë¸”ë™ë¼ë²¨ ë¼ì´íŠ¸ ë§ˆìŠ¤í¬ ì¤‘í˜• 25ê°œì…-ë°”ë‹ë¼ë² ì´ì§€", keywords: ["ë°”ë‹ë¼"] },
            { target: "ì°¸ì¡´ KF94 í†¤ì—…í• ë¸”ë™ë¼ë²¨ ë¼ì´íŠ¸ ë§ˆìŠ¤í¬ ì¤‘í˜• 25ê°œì…-ë¬´ë“œê·¸ë ˆì´", keywords: ["ê·¸ë ˆì´"] },
            { target: "ì°¸ì¡´ í†¤ì—…í• ë§ˆìŠ¤í¬ ëŒ€í˜• 25ê°œì…-ì½”ë„", keywords: ["ì½”ë„"] },
            { target: "ì°¸ì¡´ í†¤ì—…í• ë§ˆìŠ¤í¬ ëŒ€í˜• 25ê°œì…-ëˆ„ë“œì—…ë² ì´ì§€", keywords: ["ëˆ„ë“œ"] },
            
            // *** í‹°ë‹ˆí•‘ ì‹œì¦Œ6 ì‹ ì œí’ˆ ***
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 í’€ì»¤ë²„ êµì •ì¼€ì´ìŠ¤ ì„¸íŠ¸-í•˜ì¸„í•‘", keywords: ["í’€ì»¤ë²„", "í•˜ì¸„í•‘"] },
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 í’€ì»¤ë²„ êµì •ì¼€ì´ìŠ¤ ì„¸íŠ¸-ì‚¬ë¿í•‘", keywords: ["í’€ì»¤ë²„", "ì‚¬ë¿"] },
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 í’€ì»¤ë²„ êµì •ì¼€ì´ìŠ¤ ì„¸íŠ¸-ì•„ë¦„í•‘", keywords: ["í’€ì»¤ë²„", "ì•„ë¦„"] },
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 í’€ì»¤ë²„ êµì •ì¼€ì´ìŠ¤ ì„¸íŠ¸-ë½€ë‹ˆí•‘", keywords: ["í’€ì»¤ë²„", "ë½€ë‹ˆ"] },
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 ë©€í‹°ì¼€ì´ìŠ¤-í•˜ì¸„í•‘", keywords: ["ë©€í‹°ì¼€ì´ìŠ¤", "í•˜ì¸„í•‘"] },
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 ì–‘ì† êµì •ì “ê°€ë½-í•˜ì¸„í•‘", keywords: ["ì–‘ì†", "í•˜ì¸„í•‘"] },
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 êµì •ìˆ˜ì €ì„¸íŠ¸-ì•„ë¦„í•‘", keywords: ["êµì •ìˆ˜ì €", "ì•„ë¦„"] },
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 êµì •ìˆ˜ì €ì„¸íŠ¸-í•˜ì¸„í•‘", keywords: ["êµì •ìˆ˜ì €", "í•˜ì¸„í•‘"] },
            { target: "í‹°ë‹ˆí•‘ ì‹œì¦Œ6 ì§„ê³µì “ê°€ë½ì„¸íŠ¸-ë¡œì—´í•‘", keywords: ["ì§„ê³µ", "ë¡œì—´"] }
        ];

        let dbData = [], editingIndex = -1, salesChart = null;

        window.onload = function() {
            loadFromStorage();
            document.getElementById('db-date').value = new Date().toISOString().substring(0,10);
            const datalist = document.getElementById('productOptions');
            [...new Set(MATCHING_RULES.map(r => r.target))].forEach(p => {
                const option = document.createElement('option'); option.value = p; datalist.appendChild(option);
            });
            setupDropZone(); refreshAll();
        };

        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length) handleExcelUpload(e.dataTransfer.files); });
        }

        async function exportMonthlyReport(year, month) {
            const monthStr = String(month).padStart(2, '0');
            const ymStr = `${year}-${monthStr}`;
            const monthlyData = dbData.filter(d => d.date.startsWith(ymStr));
            
            if(monthlyData.length === 0) { alert('í•´ë‹¹ ì›”ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            let adCostSJ = prompt(`(SJ) ì¿ íŒ¡ ìœ™ ${month}ì›” ê´‘ê³ ë¹„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìˆ«ìë§Œ)`, "0");
            if (adCostSJ === null) return;
            let adCostSH = prompt(`(SH) ì¿ íŒ¡ ìœ™ ${month}ì›” ê´‘ê³ ë¹„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìˆ«ìë§Œ)`, "0");
            if (adCostSH === null) return;

            let costSJ = Number(adCostSJ.replace(/,/g, '')) || 0;
            let costSH = Number(adCostSH.replace(/,/g, '')) || 0;

            const productStats = {};
            monthlyData.forEach(item => {
                const p = item.product || "ì´ë¦„ì—†ìŒ";
                if(!productStats[p]) productStats[p] = {qty: 0, amount: 0};
                productStats[p].qty += item.salesQty;
                productStats[p].amount += item.amount;
            });
            const sortedProducts = Object.keys(productStats).map(k => ({name: k, ...productStats[k]})).sort((a,b) => b.qty - a.qty).slice(0, 5);

            const hiddenCanvas = document.getElementById('hiddenReportChart');
            const hiddenCtx = hiddenCanvas.getContext('2d');
            hiddenCanvas.width = 600; hiddenCanvas.height = 350;

            const reportChart = new Chart(hiddenCtx, {
                type: 'bar',
                data: {
                    labels: sortedProducts.map(p => p.name.length > 10 ? p.name.substring(0,10)+"..." : p.name),
                    datasets: [{
                        label: 'íŒë§¤ìˆ˜ëŸ‰', data: sortedProducts.map(p => p.qty),
                        backgroundColor: '#36a2eb', borderColor: '#36a2eb', borderWidth: 1
                    }]
                },
                options: { 
                    animation: false, responsive: false, indexAxis: 'y',
                    plugins: { legend: { display: false }, title: { display: true, text: `${month}ì›” ì¸ê¸°ìƒí’ˆ TOP 5`, font: {size: 16} } }
                }
            });

            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('ì›”ê°„ ë³´ê³ ì„œ');
            const borderStyle = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };

            ws.mergeCells('A1:D1');
            const titleCell = ws.getCell('A1');
            titleCell.value = `${year}ë…„ ${month}ì›” SJ Innovation ë§¤ì¶œ ë³´ê³ ì„œ`;
            titleCell.font = { size: 18, bold: true };
            titleCell.alignment = { horizontal: 'left' };
            ws.addRow([]);

            ws.getCell('A3').value = "â–  ì±„ë„ë³„ ë§¤ì¶œ í˜„í™©";
            ws.getCell('A3').font = { bold: true };

            const headerRow = ws.getRow(4);
            headerRow.values = ["ì±„ë„ëª…", "ë§¤ì¶œì•¡"]; 
            headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            ['A4', 'B4'].forEach(key => {
                const cell = ws.getCell(key);
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2C3E50' } };
                cell.alignment = { horizontal: 'center' };
                cell.border = borderStyle;
            });

            const startRow = 5;
            let currentRow = startRow;

            CHANNELS.forEach((ch, idx) => {
                const sum = monthlyData.filter(d => d.mall === ch).reduce((a,c) => a+c.amount, 0);
                const row = ws.getRow(currentRow + idx);
                row.getCell(1).value = ch;
                row.getCell(2).value = sum; 
                row.getCell(2).numFmt = '#,##0';
                row.getCell(1).border = borderStyle;
                row.getCell(2).border = borderStyle;
            });

            const subTotalRowIndex = currentRow + CHANNELS.length;
            const subRow = ws.getRow(subTotalRowIndex);
            subRow.getCell(1).value = "ë§¤ì¶œ ì†Œê³„";
            subRow.getCell(2).value = { formula: `SUM(B${startRow}:B${subTotalRowIndex-1})` };
            subRow.getCell(2).numFmt = '#,##0';
            subRow.font = { bold: true };
            subRow.getCell(1).border = borderStyle; subRow.getCell(2).border = borderStyle;

            const sjRow = ws.getRow(subTotalRowIndex + 1);
            sjRow.getCell(1).value = "(-) (SJ)ì¿ íŒ¡ ìœ™ ê´‘ê³ ";
            sjRow.getCell(2).value = costSJ;
            sjRow.getCell(2).numFmt = '#,##0';
            sjRow.font = { color: { argb: 'FFFF0000' } };
            sjRow.getCell(1).border = borderStyle; sjRow.getCell(2).border = borderStyle;

            const shRow = ws.getRow(subTotalRowIndex + 2);
            shRow.getCell(1).value = "(-) (SH)ì¿ íŒ¡ ìœ™ ê´‘ê³ ";
            shRow.getCell(2).value = costSH;
            shRow.getCell(2).numFmt = '#,##0';
            shRow.font = { color: { argb: 'FFFF0000' } };
            shRow.getCell(1).border = borderStyle; shRow.getCell(2).border = borderStyle;

            const finalRow = ws.getRow(subTotalRowIndex + 3);
            finalRow.getCell(1).value = "ìµœì¢… í•©ê³„ (ìˆœìˆ˜ìµ)";
            finalRow.getCell(2).value = { formula: `B${subTotalRowIndex} - B${subTotalRowIndex+1} - B${subTotalRowIndex+2}` };
            finalRow.getCell(2).numFmt = '#,##0';
            finalRow.font = { size: 12, bold: true, color: { argb: 'FF0000FF' } };
            finalRow.getCell(1).font = { size: 12, bold: true };
            finalRow.getCell(1).border = borderStyle; finalRow.getCell(2).border = borderStyle;

            const top5StartRow = subTotalRowIndex + 6; 
            ws.getCell(`A${top5StartRow}`).value = "â–  ì¸ê¸° ìƒí’ˆ TOP 5";
            ws.getCell(`A${top5StartRow}`).font = { bold: true };

            const top5Header = ws.getRow(top5StartRow + 1);
            top5Header.getCell(1).value = "ìˆœìœ„";
            top5Header.getCell(2).value = "ìƒí’ˆëª…";
            top5Header.getCell(3).value = "íŒë§¤ìˆ˜ëŸ‰";
            top5Header.getCell(4).value = "ë§¤ì¶œì•¡";

            for(let c=1; c<=4; c++) {
                const cell = top5Header.getCell(c);
                cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2C3E50' } };
                cell.alignment = { horizontal: 'center' };
                cell.border = borderStyle;
            }

            sortedProducts.forEach((p, idx) => {
                const r = ws.getRow(top5StartRow + 2 + idx);
                r.getCell(1).value = idx + 1;
                r.getCell(2).value = p.name;
                r.getCell(3).value = p.qty;
                r.getCell(4).value = p.amount;
                r.getCell(4).numFmt = '#,##0';
                for(let c=1; c<=4; c++) r.getCell(c).border = borderStyle;
            });

            ws.columns = [{ width: 25 }, { width: 40 }, { width: 15 }, { width: 20 }];

            const chartStartRow = top5StartRow + 2 + 5 + 2; 
            const imageId = wb.addImage({
                base64: reportChart.toBase64Image(),
                extension: 'png',
            });
            ws.addImage(imageId, {
                tl: { col: 0, row: chartStartRow }, 
                ext: { width: 500, height: 300 }
            });

            reportChart.destroy();
            const buffer = await wb.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), `SJ_Innovation_${year}ë…„_${month}ì›”_ë§¤ì¶œë³´ê³ ì„œ(ìˆœìˆ˜ìµ).xlsx`);
        }

        function exportReportToExcel() {
            const dateInput = document.getElementById('db-date').value;
            const d = new Date(dateInput);
            exportMonthlyReport(d.getFullYear(), d.getMonth()+1);
        }

        function resetFilter() {
            document.getElementById('filter-year').value = new Date().getFullYear();
            document.getElementById('filter-month').value = 'all';
            renderDB();
        }
        function refreshAll() { renderDashboard(); renderDB(); }

        function renderDashboard() {
            const dateInput = document.getElementById('db-date').value;
            const today = dateInput ? new Date(dateInput) : new Date();
            const year = today.getFullYear();
            document.getElementById('dash-title').innerText = `ğŸ“… ${year}ë…„ ì „ì²´ ë§¤ì¶œ í˜„í™©`;
            document.getElementById('chart-year').innerText = `${year}ë…„`;

            const container = document.getElementById('monthly-tables-container');
            container.innerHTML = ''; 
            let yearTotalRevenue = 0;
            const yearData = dbData.filter(d => d.date.startsWith(String(year)));

            for (let m = 1; m <= 12; m++) {
                const monthStr = String(m).padStart(2, '0');
                const lastDay = new Date(year, m, 0).getDate();
                const ymStr = `${year}-${monthStr}`;
                const monthlyData = yearData.filter(d => d.date.startsWith(ymStr));
                const monthRevenue = monthlyData.reduce((acc, curr) => acc + curr.amount, 0);
                yearTotalRevenue += monthRevenue;

                const monthDiv = document.createElement('div');
                monthDiv.className = 'mb-4';
                let tableHtml = `
                    <div class="month-header">
                        <div><span class="me-2">${m}ì›”</span><span class="badge bg-secondary fs-6">${monthRevenue.toLocaleString()}ì›</span></div>
                        <button class="btn btn-sm btn-success fw-bold text-white" onclick="exportMonthlyReport(${year}, ${m})">ğŸ“¥ ${m}ì›” ì—‘ì…€ ì €ì¥</button>
                    </div>
                    <div class="table-responsive"><table class="table table-bordered table-hover table-sm table-striped text-center mb-0"><thead><tr class="table-light"><th class="bg-light sticky-col">ì±„ë„</th><th class="bg-light">í•©ê³„</th>${Array.from({length: lastDay}, (_, i) => `<th>${i+1}ì¼</th>`).join('')}</tr></thead><tbody>`;
                CHANNELS.forEach(ch => {
                    let rowTotal = 0, cells = '';
                    for(let d=1; d<=lastDay; d++) {
                        const dayStr = String(d).padStart(2,'0');
                        const dt = `${ymStr}-${dayStr}`;
                        const sum = monthlyData.filter(item => item.date === dt && item.mall === ch).reduce((a,c) => a+c.amount, 0);
                        rowTotal += sum;
                        cells += `<td class="text-end">${sum ? sum.toLocaleString() : '-'}</td>`;
                    }
                    tableHtml += `<tr><td class="fw-bold bg-white" style="position:sticky; left:0;">${ch}</td><td class="text-end fw-bold-total">${rowTotal.toLocaleString()}</td>${cells}</tr>`;
                });
                tableHtml += `</tbody></table></div>`;
                monthDiv.innerHTML = tableHtml;
                container.appendChild(monthDiv);
            }
            document.getElementById('total-year-revenue').innerText = yearTotalRevenue.toLocaleString();
            renderChart(yearData);
        }

        function renderChart(dataScope) {
            const productSales = {};
            dataScope.forEach(item => { const name = item.product || "ì´ë¦„ì—†ìŒ"; if(!productSales[name]) productSales[name] = 0; productSales[name] += item.salesQty; });
            const sorted = Object.keys(productSales).map(k => ({name:k, qty:productSales[k]})).sort((a,b)=>b.qty-a.qty).slice(0, 5); 
            if(salesChart) salesChart.destroy();
            salesChart = new Chart(document.getElementById('salesChart').getContext('2d'), { type: 'bar', data: { labels: sorted.map(p=>p.name), datasets: [{ label: 'íŒë§¤ìˆ˜ëŸ‰', data: sorted.map(p=>p.qty), backgroundColor: '#36a2eb' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false } });
        }

        function renderDB() {
            const tbody = document.getElementById('db-body'); tbody.innerHTML = '';
            const selYear = document.getElementById('filter-year').value;
            const selMonth = document.getElementById('filter-month').value;
            let filterPrefix = selYear;
            let titleText = `${selYear}ë…„ ì „ì²´`;
            if (selMonth !== 'all') { filterPrefix = `${selYear}-${selMonth}`; titleText = `${selYear}ë…„ ${selMonth}ì›”`; }
            document.getElementById('db-list-title').innerText = titleText;

            const filteredData = dbData.map((item, idx) => ({...item, originalIndex: idx}))
                .filter(item => item.date.startsWith(filterPrefix))
                .sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('filter-info').innerText = `ì¡°íšŒ ê²°ê³¼: ${filteredData.length}ê±´`;

            filteredData.forEach((item) => {
                tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.mall}</td><td class="text-start text-truncate" style="max-width:200px;">${item.product}</td><td>${item.deliveryQty}</td><td class="text-end fw-bold">${item.amount.toLocaleString()}</td><td>${item.salesQty}</td><td>${item.receiver}</td><td>${item.csType||''}</td><td>${item.csContent||''}</td><td>${item.returnStatus||''}</td><td><button class="btn btn-xs btn-outline-primary py-0 me-1" onclick="editSale(${item.originalIndex})">ìˆ˜ì •</button><button class="btn btn-xs btn-outline-danger py-0" onclick="deleteDB(${item.originalIndex})">ì‚­ì œ</button></td></tr>`;
            });
            document.getElementById('db-count').innerText = filteredData.length;
        }

        function normalizeProductName(rawName) { if(!rawName) return ""; const cleanName = rawName.replace(/\s+/g, '').toLowerCase(); for (let rule of MATCHING_RULES) { if (rule.keywords.every(k => cleanName.includes(k.replace(/\s+/g, '').toLowerCase()))) return rule.target; } return rawName; }
        function parseMoney(val) { return Number(String(val||0).replace(/,/g, '').trim()) || 0; }
        function calculateRealSalesQty(rawName, excelQty) { if (!rawName) return excelQty; const match = rawName.match(/(\d+)\s*(íŒ©|ê°œ|set|ì„¸íŠ¸|box|ë°•ìŠ¤)(?!ì…)/i); return match ? (excelQty * parseInt(match[1])) : excelQty; }
        function getDateFromFilename(filename) { const match = filename.match(/_(\d{4})\./); if (match) { return `${new Date().getFullYear()}-${match[1].substring(0,2)}-${match[1].substring(2,4)}`; } return ""; }

        async function handleExcelUpload(files) {
            if(files.length === 0) return;
            const isForceDate = document.getElementById('force-date-check').checked;
            const manualDate = document.getElementById('db-date').value;
            if(isForceDate && !manualDate) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
            let totalSuccess = 0, lastFileDate = "";
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                let fileDateStr = "";
                let isRocketGrowth = false;
                if (file.name.includes("SELLER_INSIGHTS") || file.name.match(/_\d{4}\./)) { fileDateStr = getDateFromFilename(file.name); isRocketGrowth = true; }
                if (!fileDateStr) { const dobj = new Date(file.lastModified); fileDateStr = dobj.toISOString().substring(0,10); }
                const finalDate = isForceDate ? manualDate : fileDateStr;
                lastFileDate = finalDate;
                try {
                    const result = await processSingleFile(file, finalDate, isRocketGrowth);
                    totalSuccess += result.inserted;
                } catch (e) { console.error(`${file.name} ì˜¤ë¥˜:`, e); }
            }
            if (lastFileDate) document.getElementById('db-date').value = lastFileDate;
            saveToStorage(); refreshAll();
            const modeMsg = isForceDate ? "ê°•ì œ ì ìš©ë¨" : "íŒŒì¼ ë‚ ì§œ ì ìš©ë¨";
            alert(`âœ… ì²˜ë¦¬ ì™„ë£Œ!\n- ì´ ë“±ë¡: ${totalSuccess}ê±´ (0ì›/ìŒìˆ˜ ì œì™¸)\n- ê¸°ì¤€ì¼: ${lastFileDate}\n(${modeMsg})`);
            document.getElementById('excelUpload').value = '';
        }

        function processSingleFile(file, dateStr, isRocketGrowth) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                        if(jsonData.length < 1) { resolve({inserted:0, skipped:0}); return; }
                        let headerRow = -1, platform = 'UNKNOWN', colMap = {};
                        for(let r=0; r<Math.min(10, jsonData.length); r++) {
                            const rowStr = JSON.stringify(jsonData[r]);
                            if(rowStr.includes('ìˆ˜ì§‘ì¼') && rowStr.includes('ìˆ˜ì·¨ì¸ëª…')) { headerRow = r; platform = 'SJ_BACKUP'; break; }
                            else if(rowStr.includes('ìƒí’ˆì£¼ë¬¸ë²ˆí˜¸')) { headerRow = r; platform = 'SMARTSTORE'; break; } 
                            else if(rowStr.includes('ë“±ë¡ìƒí’ˆëª…')) { headerRow = r; platform = 'COUPANG'; break; } 
                            else if(rowStr.includes('íŒë§¤ì•„ì´ë””')) { headerRow = r; platform = 'GMARKET'; break; } 
                            else if(rowStr.includes('íŒë§¤ëŸ‰') && rowStr.includes('ë§¤ì¶œ(ì›)')) { headerRow = r; platform = 'ROCKET_GROWTH'; break; }
                        }
                        if(headerRow === -1) { resolve({inserted:0, skipped:0}); return; }
                        jsonData[headerRow].forEach((col, idx) => { if(col) colMap[String(col).trim()] = idx; });
                        let inserted = 0;
                        for(let i = headerRow + 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if(!row || row.length === 0) continue;
                            let newOrder = { date: dateStr, mall: '', product: '', deliveryQty: 1, amount: 0, salesQty: 1, receiver: '', csType: '', csContent: '', returnStatus: '', rawId: '' };
                            let rawProductName = "", excelQty = 1;

                            if (platform === 'SJ_BACKUP') {
                                newOrder.date = row[colMap['ìˆ˜ì§‘ì¼']] || dateStr; newOrder.mall = row[colMap['ì‡¼í•‘ëª°']];
                                newOrder.rawId = row[colMap['ID']] || `BACKUP-${i}`; rawProductName = row[colMap['ìƒí’ˆëª…']]; newOrder.product = rawProductName;
                                newOrder.amount = parseMoney(row[colMap['ê²°ì œê¸ˆì•¡']]); newOrder.salesQty = parseMoney(row[colMap['íŒë§¤ìˆ˜ëŸ‰']]); newOrder.receiver = row[colMap['ìˆ˜ì·¨ì¸ëª…']];
                                if(!dbData.some(d => d.rawId == newOrder.rawId)) { dbData.push(newOrder); inserted++; } continue; 
                            } else if (platform === 'SMARTSTORE') {
                                if(!row[colMap['ìƒí’ˆì£¼ë¬¸ë²ˆí˜¸']]) continue; newOrder.mall = 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´'; newOrder.rawId = row[colMap['ìƒí’ˆì£¼ë¬¸ë²ˆí˜¸']];
                                rawProductName = row[colMap['ìƒí’ˆëª…']] + (row[colMap['ì˜µì…˜ì •ë³´']] ? ' ' + row[colMap['ì˜µì…˜ì •ë³´']] : ''); newOrder.amount = parseMoney(row[colMap['ìµœì¢… ìƒí’ˆë³„ ì´ ì£¼ë¬¸ê¸ˆì•¡']] || row[colMap['ìƒí’ˆê°€ê²©']]); excelQty = Number(row[colMap['ìˆ˜ëŸ‰']] || 1); newOrder.receiver = row[colMap['ìˆ˜ì·¨ì¸ëª…']];
                            } else if (platform === 'COUPANG') {
                                if(!row[colMap['ì£¼ë¬¸ë²ˆí˜¸']]) continue; newOrder.mall = 'ì¿ íŒ¡ ìœ™'; newOrder.rawId = row[colMap['ì£¼ë¬¸ë²ˆí˜¸']];
                                rawProductName = (row[colMap['ë“±ë¡ìƒí’ˆëª…']]||'') + ' ' + (row[colMap['ë“±ë¡ì˜µì…˜ëª…']]||''); if(rawProductName.trim() === '') rawProductName = row[colMap['ë…¸ì¶œìƒí’ˆëª…(ì˜µì…˜ëª…)']] || '';
                                let price = parseMoney(row[colMap['ê²°ì œì•¡']]); if(!price) price = parseMoney(row[colMap['ì˜µì…˜íŒë§¤ê°€(íŒë§¤ë‹¨ê°€)']]) * Number(row[colMap['êµ¬ë§¤ìˆ˜(ìˆ˜ëŸ‰)']]); newOrder.amount = price; excelQty = Number(row[colMap['êµ¬ë§¤ìˆ˜(ìˆ˜ëŸ‰)']] || 1); newOrder.receiver = row[colMap['ìˆ˜ì·¨ì¸ì´ë¦„']] || row[colMap['êµ¬ë§¤ìì´ë¦„']];
                            } else if (platform === 'ROCKET_GROWTH') {
                                if(!row[colMap['ìƒí’ˆëª…']]) continue; excelQty = parseMoney(row[colMap['íŒë§¤ëŸ‰']]);
                                let amt = parseMoney(row[colMap['ë§¤ì¶œ(ì›)']]);
                                if (amt <= 0) { continue; } // 0ì› ì´í•˜ ì œì™¸
                                newOrder.mall = 'ì¿ íŒ¡ ë¡œì¼“ê·¸ë¡œìŠ¤'; newOrder.rawId = `GROWTH-${dateStr}-${i}`; rawProductName = (row[colMap['ìƒí’ˆëª…']]||'') + ' ' + (row[colMap['ì˜µì…˜ëª…']]||'');
                                newOrder.amount = amt; newOrder.receiver = 'ì¿ íŒ¡'; 
                            } else if (platform === 'GMARKET') {
                                if(!row[colMap['ì£¼ë¬¸ë²ˆí˜¸']]) continue; newOrder.mall = 'ì§€ë§ˆì¼“'; newOrder.rawId = row[colMap['ì£¼ë¬¸ë²ˆí˜¸']]; rawProductName = row[colMap['ìƒí’ˆëª…']]; newOrder.amount = parseMoney(row[colMap['íŒë§¤ê¸ˆì•¡']] || (row[colMap['íŒë§¤ë‹¨ê°€']] * row[colMap['ìˆ˜ëŸ‰']])); excelQty = Number(row[colMap['ìˆ˜ëŸ‰']] || 1); newOrder.receiver = row[colMap['ìˆ˜ë ¹ì¸ëª…']];
                            }
                            
                            // ê³µí†µ: 0ì› ì´í•˜ëŠ” ì œì™¸
                            if (newOrder.amount <= 0) { continue; }

                            newOrder.product = normalizeProductName(rawProductName); newOrder.deliveryQty = 1; newOrder.salesQty = calculateRealSalesQty(rawProductName, excelQty);
                            if(!dbData.some(d => d.rawId == newOrder.rawId)) { dbData.push(newOrder); inserted++; }
                        }
                        resolve({inserted: inserted});
                    } catch(err) { reject(err); }
                }; reader.readAsArrayBuffer(file);
            });
        }

        function editSale(index) { editingIndex = index; const item = dbData[index]; document.getElementById('db-date').value = item.date; document.getElementById('db-mall').value = item.mall; document.getElementById('db-product').value = item.product; document.getElementById('db-amount').value = item.amount; document.getElementById('db-sales-qty').value = item.salesQty; document.getElementById('db-receiver').value = item.receiver; document.getElementById('db-cs-type').value = item.csType||''; document.getElementById('db-cs-content').value = item.csContent||''; document.getElementById('db-return').value = item.returnStatus||''; document.getElementById('formTitle').innerText = "âœï¸ ìˆ˜ì • ì¤‘..."; document.getElementById('submitBtn').innerText = "ğŸ’¾ ì €ì¥"; document.getElementById('submitBtn').classList.replace('btn-primary', 'btn-success'); document.getElementById('cancelEditBtn').style.display = 'block'; document.getElementById('inputFormArea').classList.add('editing-mode'); document.getElementById('inputFormArea').scrollIntoView({ behavior: 'smooth' }); }
        function cancelEdit() { editingIndex = -1; document.getElementById('db-product').value = ''; document.getElementById('db-amount').value = ''; document.getElementById('db-receiver').value = ''; document.getElementById('db-cs-type').value = ''; document.getElementById('db-cs-content').value = ''; document.getElementById('db-return').value = ''; document.getElementById('formTitle').innerText = "âœï¸ ë°ì´í„° ì…ë ¥"; document.getElementById('submitBtn').innerText = "â• ì¶”ê°€"; document.getElementById('submitBtn').classList.replace('btn-success', 'btn-primary'); document.getElementById('cancelEditBtn').style.display = 'none'; document.getElementById('inputFormArea').classList.remove('editing-mode'); }
        function addOrUpdateSale() { const date = document.getElementById('db-date').value; const amount = document.getElementById('db-amount').value; if(!date || !amount) return alert('ë‚ ì§œ/ê¸ˆì•¡ í•„ìˆ˜'); const newItem = { date: date, mall: document.getElementById('db-mall').value, product: document.getElementById('db-product').value, deliveryQty: 1, amount: Number(amount), salesQty: Number(document.getElementById('db-sales-qty').value), receiver: document.getElementById('db-receiver').value, csType: document.getElementById('db-cs-type').value, csContent: document.getElementById('db-cs-content').value, returnStatus: document.getElementById('db-return').value, rawId: editingIndex > -1 ? dbData[editingIndex].rawId : ('MANUAL-'+Date.now()) }; if(editingIndex > -1) { dbData[editingIndex] = newItem; alert('ìˆ˜ì •ì™„ë£Œ'); cancelEdit(); } else { dbData.push(newItem); document.getElementById('db-product').value=''; document.getElementById('db-amount').value=''; } saveToStorage(); refreshAll(); }
        function deleteDB(idx) { if(confirm('ì‚­ì œ?')) { dbData.splice(idx, 1); saveToStorage(); refreshAll(); } }
        function clearDB() { if(confirm('ì „ì²´ì‚­ì œ?')) { dbData=[]; saveToStorage(); refreshAll(); } }
        function saveToStorage() { localStorage.setItem('sj_sales_v36', JSON.stringify({ db: dbData })); }
        function loadFromStorage() { const s = localStorage.getItem('sj_sales_v36'); if(s) { const p=JSON.parse(s); dbData=p.db||[]; } }
        function downloadData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem('sj_sales_v36')); a.download = "SH_ë§¤ì¶œë°±ì—….json"; a.click(); }
        function loadDataFromBackup(input) { const r = new FileReader(); r.onload = e => { localStorage.setItem('sj_sales_v36', e.target.result); location.reload(); }; r.readAsText(input.files[0]); }
        function resetData() { if(confirm('ì´ˆê¸°í™”?')) { localStorage.removeItem('sj_sales_v36'); location.reload(); } }
    </script>
</body>
</html>
